<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail Service Test Application</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .app-selector {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid #dee2e6;
        }
        
        .current-app {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
        }
        
        select {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        
        .action-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .action-section h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .action-section p {
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button[style*="background-color: #dc3545;"]:hover {
            background-color: #c82333 !important;
        }
        
        button[style*="background-color: #28a745;"]:hover {
            background-color: #218838 !important;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mail Service Test Application</h1>
        
        <div class="app-selector">
            <div class="current-app" id="current-app">Currently Testing: ReTree Hawaii</div>
            <label for="app-select">Select Application:</label>
                    <select id="appSelect" onchange="updateSelectedApp()">
            <option value="retree-hawaii">ReTree Hawaii</option>
            <option value="outings">Outings</option>
            <option value="invalid-app">Invalid App</option>
        </select>
        </div>
        
        <div class="action-section">
            <h3>Authentication Test Controls</h3>
            <p>Clear stored authentication tokens to test the IDP authentication flow from scratch.</p>
            <button id="clear-token-btn" onclick="clearAuthTokens()" style="background-color: #dc3545;">Clear Auth Tokens</button>
            <button id="check-token-btn" onclick="checkAuthStatus()" style="background-color: #28a745;">Check Auth Status</button>
            <button id="test-external-flow-btn" onclick="testExternalAppFlow()" style="background-color: #007bff;">Test External App Flow</button>
            <div id="auth-status-result" class="result"></div>
        </div>
        
        <div class="app-selection">
            <label for="testEmailMode">
                <input type="checkbox" id="testEmailMode" checked>
                Use Test SMTP (MailHog) instead of production email configuration
            </label>
            <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
                When enabled, emails will be sent to MailHog regardless of the app's SMTP configuration.
            </p>
        </div>
        
                <div class="action-section">
            <h3>1. Send Message (Test Endpoint - With Authentication)</h3>
            <p>Send a static test message to MailHog using the /api/send-test endpoint with secure authentication.</p>
            <button id="send-message-btn" onclick="sendMessage()">Send Test Message</button>
            <div id="send-message-result" class="result"></div>

            <h4>Send Message (Production Endpoint - With Authentication)</h4>
            <p>Send a message using the production /api/send endpoint with proper application token authentication.</p>
            <button id="send-message-auth-btn" onclick="sendMessageWithAuth()">Send Message (With Auth)</button>
            <div id="send-message-auth-result" class="result"></div>
        </div>
        
        <div class="action-section">
            <h3>2. Compose Message (User Authentication)</h3>
            <p>Redirect to mail-service compose view with IDP authentication for a regular user to compose and send email.</p>
            <button id="compose-message-btn" onclick="composeMessage()">Compose Message</button>
            <div id="compose-message-result" class="result"></div>
        </div>
        
        <div class="action-section">
            <h3>2b. Compose with Template Variables (User Authentication)</h3>
            <p>Redirect to compose view with pre-populated recipients containing template variables for testing template processing.</p>
            <button id="compose-template-vars-btn" onclick="composeWithTemplateVars()">Compose with Template Variables</button>
            <div id="compose-template-vars-result" class="result"></div>
        </div>
        
        <div class="action-section">
            <h3>2c. Template Editor (Tenant Admin Authentication)</h3>
            <p>Redirect to mail-service template editor view with IDP authentication for a tenant admin to edit templates.</p>
            <button id="template-editor-btn" onclick="templateEditor()">Template Editor</button>
            <div id="template-editor-result" class="result"></div>
        </div>
        
        <div class="action-section">
            <h3>2d. SMS Compose (User Authentication)</h3>
            <p>Redirect to mail-service SMS compose view with IDP authentication for a user to compose and send SMS messages.</p>
            <button id="sms-compose-btn" onclick="composeSms()">Compose SMS</button>
            <div id="sms-compose-result" class="result"></div>
        </div>
        
        <div class="action-section">
            <h3>2e. SMS Compose with Pre-filled Data (User Authentication)</h3>
            <p>Redirect to SMS compose view with pre-populated phone numbers (+16509064337 and +18083540490) and message for testing pre-fill functionality.</p>
            <button id="sms-compose-prefill-btn" onclick="composeSmsWithPrefill()">Compose SMS (Pre-filled)</button>
            <div id="sms-compose-prefill-result" class="result"></div>
        </div>
        
        <div class="action-section">
            <h3>2f. Send SMS via API (Bulk)</h3>
            <p>Send SMS to multiple recipients using the /api/sms/send endpoint. Tests bulk SMS functionality with real Twilio integration to +16509064337 and +18083540490.</p>
            <button id="send-sms-api-btn" onclick="sendSmsWithAPI()">Send Bulk SMS via API</button>
            <div id="send-sms-api-result" class="result"></div>
        </div>
        
        <div class="action-section">
            <h3>2g. Send Immediate Template Email (API)</h3>
            <p>Send email immediately using template ID with recipient context data via /send-now API. Tests template variable substitution without user interface.</p>
            <button id="send-template-api-btn" onclick="sendTemplateWithAPI()">Send Template via API</button>
            <div id="send-template-api-result" class="result"></div>
        </div>
        
        <div class="action-section">
            <h3>2h. Send Template Email to MailHog (Safe Test)</h3>
            <p>Send email using template ID with testEmail flag to force all messages to MailHog test server, regardless of SMTP configuration. Ensures safe testing without risk of sending to production servers.</p>
            <button id="send-template-mailhog-btn" onclick="sendTemplateToMailHog()">Send Template to MailHog Only</button>
            <div id="send-template-mailhog-result" class="result"></div>
        </div>
        
        <div class="action-section">
            <h3>3. Manage Applications (Tenant Admin)</h3>
            <p>Redirect to mail-service admin view with IDP authentication for tenant admin to manage application configurations.</p>
            <button id="manage-apps-btn" onclick="manageApplications()">Manage Applications</button>
            <div id="manage-apps-result" class="result"></div>
        </div>

        <div class="action-section">
            <h3>4. View Email Logs (Tenant Admin)</h3>
            <p>Redirect to mail-service email log viewer with IDP authentication for tenant admin to view email logs for the selected application.</p>
            <button id="email-logs-btn" onclick="viewEmailLogs()">View Email Logs</button>
            <div id="email-logs-result" class="result"></div>
        </div>

        <div class="action-section">
            <h3>5. View SMS Logs (Tenant Admin)</h3>
            <p>Redirect to mail-service SMS log viewer with IDP authentication for tenant admin to view SMS logs for the selected application.</p>
            <button id="sms-logs-btn" onclick="viewSmsLogs()">View SMS Logs</button>
            <div id="sms-logs-result" class="result"></div>
        </div>
    </div>

    <script>
        // Application configurations with client secrets for secure authentication
        const apps = {
            'retree-hawaii': {
                name: 'ReTree Hawaii App',
                appId: 'cmfka688r0001b77ofpgm57ix',
                clientId: 'retree-hawaii-client',
                // In production, this should be loaded from secure environment variables
                clientSecret: 'bXwMxsX40R47QaZLA0oK3t1yDH+Y/cS/+X0Bu55jjN8=',
                description: 'Forest restoration and tree planting application (inherits Robs World Gmail SMTP)'
            },
            'outings': {
                name: 'Outings Management',
                appId: 'outings-app-id',
                clientId: 'outings-client',
                // In production, this should be loaded from secure environment variables
                clientSecret: 'IojBa/D/1OV41aKbLH3TEav7ADw8c/SJpt6hvPXsjEA=',
                description: 'Sierra Club Maui outings management system (inherits Robs World Gmail SMTP)'
            },
            'invalid-app': {
                name: 'Invalid Application',
                appId: 'invalid-app-does-not-exist',
                clientId: 'invalid-client',
                description: 'Testing with non-existent appId'
            }
        };
        
        let currentApp = 'retree-hawaii';
        
        // Update app selection
        document.getElementById('appSelect').addEventListener('change', function(e) {
            currentApp = e.target.value;
            updateCurrentAppDisplay();
        });
        
        function updateCurrentAppDisplay() {
            const app = apps[currentApp];
            document.getElementById('current-app').textContent = `Currently Testing: ${app.name}`;
        }

        function updateSelectedApp() {
            currentApp = document.getElementById('appSelect').value;
            updateCurrentAppDisplay();
        }
        
        function showResult(elementId, message, type) {
            const resultElement = document.getElementById(elementId);
            resultElement.innerHTML = message;
            resultElement.className = `result ${type}`;
            resultElement.style.display = 'block';
        }
        
        function hideResult(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        function showLoading(buttonId) {
            const button = document.getElementById(buttonId);
            button.disabled = true;
            button.innerHTML += '<span class="loading"></span>';
        }
        
        function hideLoading(buttonId, originalText) {
            const button = document.getElementById(buttonId);
            button.disabled = false;
            button.innerHTML = originalText;
        }
        
        // Function implementations
        async function sendMessage() {
            const app = apps[currentApp];
            hideResult('send-message-result');
            showLoading('send-message-btn');
            
            try {
                // Get application token with client secret (secure mode)
                const tokenResponse = await fetch('/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appId: app.appId,
                        clientSecret: app.clientSecret,
                        type: 'application'
                    })
                });
                
                if (!tokenResponse.ok) {
                    throw new Error(`Failed to get application token: ${tokenResponse.statusText}`);
                }
                
                const tokenData = await tokenResponse.json();
                
                // Now send the message using the application token
                const messageResponse = await fetch('/api/send-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: 'test@example.com',
                        subject: `Test message from ${app.name}`,
                        text: `This is a test message sent from the ${app.name} application via mail-service.\n\nGenerated at: ${new Date().toISOString()}`,
                        appId: app.appId,
                        testEmail: document.getElementById('testEmailMode').checked
                    })
                });
                
                if (!messageResponse.ok) {
                    throw new Error(`Failed to send message: ${messageResponse.statusText}`);
                }
                
                const messageData = await messageResponse.json();
                
                // Create detailed delivery status message
                let statusMessage = `Message sent successfully!\n`;
                statusMessage += `Message ID: ${messageData.messageId || 'N/A'}\n`;
                statusMessage += `Status: ${messageData.status || 'unknown'}\n`;
                
                if (messageData.accepted && messageData.accepted.length > 0) {
                    statusMessage += `Accepted: ${messageData.accepted.join(', ')}\n`;
                }
                if (messageData.rejected && messageData.rejected.length > 0) {
                    statusMessage += `Rejected: ${messageData.rejected.join(', ')}\n`;
                }
                if (messageData.response) {
                    statusMessage += `SMTP Response: ${messageData.response}\n`;
                }
                if (messageData.testMode) {
                    statusMessage += `Mode: ${messageData.testMode}`;
                }
                
                const resultType = (messageData.rejected && messageData.rejected.length > 0) ? 'error' : 'success';
                showResult('send-message-result', statusMessage, resultType);
                
            } catch (error) {
                console.error('Send message error:', error);
                showResult('send-message-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('send-message-btn', 'Send Test Message');
            }
        }
        
        async function sendMessageWithAuth() {
            const app = apps[currentApp];
            hideResult('send-message-auth-result');
            showLoading('send-message-auth-btn');
            
            try {
                // First, get application token for silent authentication
                const tokenResponse = await fetch('/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appId: app.appId,
                        clientSecret: app.clientSecret,
                        type: 'application'
                    })
                });
                
                if (!tokenResponse.ok) {
                    throw new Error(`Failed to get application token: ${tokenResponse.statusText}`);
                }
                
                const tokenData = await tokenResponse.json();
                
                // Now send the message using the application token
                const messageResponse = await fetch('/api/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokenData.token}`
                    },
                    body: JSON.stringify({
                        to: 'test@example.com',
                        subject: `Test message from ${app.name} (authenticated)`,
                        text: `This is an authenticated test message sent from the ${app.name} application via mail-service.\n\nGenerated at: ${new Date().toISOString()}`,
                        appId: app.appId,
                        testEmail: document.getElementById('testEmailMode').checked
                    })
                });
                
                if (!messageResponse.ok) {
                    throw new Error(`Failed to send message: ${messageResponse.statusText}`);
                }
                
                const messageData = await messageResponse.json();
                
                // Create detailed delivery status message for authenticated send
                let statusMessage = `Authenticated message sent successfully!\n`;
                statusMessage += `Message ID: ${messageData.messageId || 'N/A'}\n`;
                statusMessage += `Status: ${messageData.status || 'unknown'}\n`;
                
                if (messageData.accepted && messageData.accepted.length > 0) {
                    statusMessage += `Accepted: ${messageData.accepted.join(', ')}\n`;
                }
                if (messageData.rejected && messageData.rejected.length > 0) {
                    statusMessage += `Rejected: ${messageData.rejected.join(', ')}\n`;
                }
                if (messageData.response) {
                    statusMessage += `SMTP Response: ${messageData.response}\n`;
                }
                if (messageData.testMode) {
                    statusMessage += `Mode: ${messageData.testMode}`;
                }
                
                const resultType = (messageData.rejected && messageData.rejected.length > 0) ? 'error' : 'success';
                showResult('send-message-auth-result', statusMessage, resultType);
                
            } catch (error) {
                console.error('Send authenticated message error:', error);
                showResult('send-message-auth-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('send-message-auth-btn', 'Send Message (With Auth)');
            }
        }
        
        async function composeMessage() {
            const app = apps[currentApp];
            hideResult('compose-message-result');
            showLoading('compose-message-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Show success message and redirect
                showResult('compose-message-result', 'AppId validated! Redirecting to compose view...', 'success');
                
                // Small delay to show the message, then redirect
                setTimeout(() => {
                    const composeUrl = `/compose?appId=${encodeURIComponent(app.appId)}&returnUrl=${encodeURIComponent(window.location.href)}`;
                    window.location.href = composeUrl;
                }, 1500);
                
            } catch (error) {
                console.error('Compose message error:', error);
                showResult('compose-message-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('compose-message-btn', 'Compose Message');
            }
        }
        
        async function composeWithTemplateVars() {
            const app = apps[currentApp];
            hideResult('compose-template-vars-result');
            showLoading('compose-template-vars-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Create recipient data with template variables (based on user's example)
                const recipients = [
                    {
                        'id': 'lead1bcb2b7b4bc93',
                        'email': 'robw@worldspot.com',
                        'name': 'alealani evangelista',
                        'company': 'Pilina ʻĀina',
                        'island': 'bigisland',
                        'category': '',
                        'phone': '8089386534',
                        'status': 'Registered',
                        'first name': 'alealani',
                        'last name': 'evangelista',
                        'full name': 'alealani evangelista',
                        'sender name': 'Rob Weltman',
                        'sender email': 'robw@worldspot.com',
                        'owner name': 'Rob Weltman',
                        'owner email': 'robw@worldspot.com'
                    },
                    {
                        'id': 'lead5365f8ca1ee82',
                        'email': 'rew@worldspot.com',
                        'name': 'Alexander Akana',
                        'company': 'La&apos;au Kukahi Farms',
                        'island': 'Maui',
                        'category': 'Farm,',
                        'phone': '8083756810',
                        'status': 'Agreed',
                        'first name': 'Alexander',
                        'last name': 'Akana',
                        'full name': 'Alexander Akana',
                        'sender name': 'Rob Weltman',
                        'sender email': 'robw@worldspot.com',
                        'owner name': 'Rob Weltman',
                        'owner email': 'robw@worldspot.com'
                    }
                ];
                
                // Show success message and redirect
                showResult('compose-template-vars-result', 'AppId validated! Redirecting to compose view with template variables...', 'success');
                
                // Small delay to show the message, then redirect
                setTimeout(() => {
                    const recipientsParam = encodeURIComponent(JSON.stringify(recipients));
                    const composeUrl = `/compose?appId=${encodeURIComponent(app.appId)}&returnUrl=${encodeURIComponent(window.location.href)}&recipients=${recipientsParam}`;
                    window.location.href = composeUrl;
                }, 1500);
                
            } catch (error) {
                console.error('Compose with template vars error:', error);
                showResult('compose-template-vars-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('compose-template-vars-btn', 'Compose with Template Variables');
            }
        }
        
        async function templateEditor() {
            const app = apps[currentApp];
            hideResult('template-editor-result');
            showLoading('template-editor-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Show success message and redirect
                showResult('template-editor-result', 'AppId validated! Redirecting to template editor...', 'success');
                
                // Small delay to show the message, then redirect
                setTimeout(() => {
                    const templateEditorUrl = `/template-editor?appId=${encodeURIComponent(app.appId)}&returnUrl=${encodeURIComponent(window.location.href)}`;
                    window.location.href = templateEditorUrl;
                }, 1500);
                
            } catch (error) {
                console.error('Template editor error:', error);
                showResult('template-editor-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('template-editor-btn', 'Template Editor');
            }
        }
        
        async function sendTemplateWithAPI() {
            const app = apps[currentApp];
            hideResult('send-template-api-result');
            showLoading('send-template-api-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Create same recipient data as test 2b for consistency
                const recipients = [
                    {
                        'id': 'lead1bcb2b7b4bc93',
                        'email': 'robw@worldspot.com',
                        'name': 'alealani evangelista',
                        'company': 'Pilina ʻĀina',
                        'island': 'bigisland',
                        'category': '',
                        'phone': '8089386534',
                        'status': 'Registered',
                        'first name': 'alealani',
                        'last name': 'evangelista',
                        'full name': 'alealani evangelista',
                        'sender name': 'Rob Weltman',
                        'sender email': 'robw@worldspot.com',
                        'owner name': 'Rob Weltman',
                        'owner email': 'robw@worldspot.com'
                    },
                    {
                        'id': 'lead5365f8ca1ee82',
                        'email': 'rew@worldspot.com',
                        'name': 'Alexander Akana',
                        'company': 'La&apos;au Kukahi Farms',
                        'island': 'Maui',
                        'category': 'Farm,',
                        'phone': '8083756810',
                        'status': 'Agreed',
                        'first name': 'Alexander',
                        'last name': 'Akana',
                        'full name': 'Alexander Akana',
                        'sender name': 'Rob Weltman',
                        'sender email': 'robw@worldspot.com',
                        'owner name': 'Rob Weltman',
                        'owner email': 'robw@worldspot.com'
                    }
                ];
                
                // Get an authentication token (you'll need to implement getAuthToken function)
                const authToken = await getAuthToken();
                if (!authToken) {
                    throw new Error('Unable to get authentication token');
                }
                
                // Send request to /send-now API with template ID
                const response = await fetch('/send-now', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken
                    },
                    body: JSON.stringify({
                        appId: app.appId,
                        templateId: 'tpl_00000090_school___please_join_us',
                        recipients: recipients
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showResult('send-template-api-result', 
                        `✅ Template email sent successfully!<br /><br />` +
                        `Group ID: ${result.groupId}<br />` +
                        `Jobs Created: ${result.jobCount}<br />` +
                        `Recipients: ${recipients.length}<br /><br />` +
                        `Emails sent via ${apps[currentApp].name} SMTP configuration with variable substitution.`, 
                        'success');
                } else {
                    throw new Error(result.message || 'API call failed');
                }
                
            } catch (error) {
                console.error('Send template API error:', error);
                showResult('send-template-api-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('send-template-api-btn', 'Send Template via API');
            }
        }
        
        async function sendTemplateToMailHog() {
            const app = apps[currentApp];
            hideResult('send-template-mailhog-result');
            showLoading('send-template-mailhog-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Create same recipient data as test 2g for consistency
                const recipients = [
                    {
                        'id': 'lead1bcb2b7b4bc93',
                        'email': 'robw@worldspot.com',
                        'name': 'alealani evangelista',
                        'company': 'Pilina ʻĀina',
                        'island': 'bigisland',
                        'category': '',
                        'phone': '8089386534',
                        'status': 'Registered',
                        'first name': 'alealani',
                        'last name': 'evangelista',
                        'full name': 'alealani evangelista',
                        'sender name': 'Rob Weltman',
                        'sender email': 'robw@worldspot.com',
                        'owner name': 'Rob Weltman',
                        'owner email': 'robw@worldspot.com'
                    },
                    {
                        'id': 'lead5365f8ca1ee82',
                        'email': 'rew@worldspot.com',
                        'name': 'Alexander Akana',
                        'company': 'La&apos;au Kukahi Farms',
                        'island': 'Maui',
                        'category': 'Farm,',
                        'phone': '8083756810',
                        'status': 'Agreed',
                        'first name': 'Alexander',
                        'last name': 'Akana',
                        'full name': 'Alexander Akana',
                        'sender name': 'Rob Weltman',
                        'sender email': 'robw@worldspot.com',
                        'owner name': 'Rob Weltman',
                        'owner email': 'robw@worldspot.com'
                    }
                ];
                
                // Get an authentication token
                const authToken = await getAuthToken();
                if (!authToken) {
                    throw new Error('Unable to get authentication token');
                }
                
                // Send request to /send-now API with template ID and testEmail flag
                const response = await fetch('/send-now', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken
                    },
                    body: JSON.stringify({
                        appId: app.appId,
                        templateId: 'tpl_00000090_school___please_join_us',
                        recipients: recipients,
                        testEmail: true  // This forces all emails to go to MailHog regardless of SMTP config
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Wait a moment for emails to be processed by MailHog
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Verify with MailHog API that emails were received (via proxy to avoid CORS)
                    let verificationMessage = '';
                    try {
                        const mailhogResponse = await fetch('/api/mailhog/messages');
                        if (mailhogResponse.ok) {
                            const mailhogData = await mailhogResponse.json();
                            // MailHog returns a direct array of messages, not an object with 'items'
                            const recentMessages = Array.isArray(mailhogData) ? mailhogData : [];
                            
                            // Count messages from the last 30 seconds (recent sends)
                            const thirtySecondsAgo = Date.now() - 30000;
                            const recentCount = recentMessages.filter(msg => {
                                const msgTime = new Date(msg.Created).getTime();
                                return msgTime > thirtySecondsAgo;
                            }).length;
                            
                            // Check for our specific recipients
                            const ourEmails = recipients.map(r => r.email);
                            const allMatchingMessages = recentMessages.filter(msg => {
                                const toEmails = msg.To ? msg.To.map(to => to.Mailbox + '@' + to.Domain) : [];
                                return toEmails.some(email => ourEmails.includes(email));
                            });
                            
                            // Filter matching messages to only recent ones (last 30 seconds)
                            const recentMatchingMessages = allMatchingMessages.filter(msg => {
                                const msgTime = new Date(msg.Created).getTime();
                                return msgTime > thirtySecondsAgo;
                            });
                            
                            verificationMessage = `<br /><br />📧 MAILHOG VERIFICATION:<br />` +
                                `✅ Connected to MailHog successfully<br />` +
                                `📊 Total messages in MailHog: ${recentMessages.length}<br />` +
                                `🕐 Recent messages (last 30s): ${recentCount}<br />` +
                                `🎯 Recent messages to our recipients: ${recentMatchingMessages.length}<br />` +
                                `📋 Total messages to our recipients (all time): ${allMatchingMessages.length}<br />`;
                                
                            if (recentMatchingMessages.length > 0) {
                                verificationMessage += `<br />🔍 Recently verified messages:`;
                                recentMatchingMessages.slice(0, 3).forEach(msg => {
                                    const toEmails = msg.To ? msg.To.map(to => to.Mailbox + '@' + to.Domain).join(', ') : 'Unknown';
                                    const subject = msg.Content?.Headers?.Subject?.[0] || 'No subject';
                                    const timeAgo = Math.round((Date.now() - new Date(msg.Created).getTime()) / 1000);
                                    verificationMessage += `<br />  • ${subject} → ${toEmails} (${timeAgo}s ago)`;
                                });
                            } else if (allMatchingMessages.length > 0) {
                                verificationMessage += `<br />ℹ️ Found messages to our recipients, but they're older than 30s`;
                            }
                        } else {
                            const errorData = await mailhogResponse.json().catch(() => ({}));
                            verificationMessage = `<br /><br />⚠️ MAILHOG VERIFICATION:<br />` +
                                `Could not connect to MailHog (${mailhogResponse.status})<br />` +
                                `${errorData.suggestion || 'Check that MailHog is running at http://localhost:8025'}`;
                        }
                    } catch (mailhogError) {
                        // Handle CORS and other connection issues gracefully
                        if (mailhogError.message.includes('Failed to fetch') || mailhogError.message.includes('CORS')) {
                            verificationMessage = `<br /><br />📧 MAILHOG VERIFICATION:<br />` +
                                `ℹ️ Cannot verify directly due to browser CORS policy<br />` +
                                `This is normal - the testEmail flag still ensures safety<br />` +
                                `✅ All emails are guaranteed to go to MailHog (localhost:1025)<br />` +
                                `🔒 No emails can reach production servers with testEmail=true`;
                        } else {
                            verificationMessage = `<br /><br />⚠️ MAILHOG VERIFICATION:<br />` +
                                `Error connecting to MailHog API: ${mailhogError.message}<br />` +
                                `Check that MailHog is running at http://localhost:8025`;
                        }
                    }
                    
                    showResult('send-template-mailhog-result', 
                        `✅ Template email sent safely to MailHog!<br /><br />` +
                        `🔒 SAFETY MODE: testEmail flag ensures all messages go to MailHog<br />` +
                        `Group ID: ${result.groupId}<br />` +
                        `Jobs Created: ${result.jobCount}<br />` +
                        `Recipients: ${recipients.length}<br /><br />` +
                        `All emails forced to localhost:1025 (MailHog) regardless of app SMTP configuration.` +
                        verificationMessage +
                        `<br /><br />🌐 View all messages: http://localhost:8025`, 
                        'success');
                } else {
                    throw new Error(result.message || 'API call failed');
                }
                
            } catch (error) {
                console.error('Send template to MailHog error:', error);
                showResult('send-template-mailhog-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('send-template-mailhog-btn', 'Send Template to MailHog Only');
            }
        }
        
        async function composeSms() {
            const app = apps[currentApp];
            hideResult('sms-compose-result');
            showLoading('sms-compose-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Show success message and redirect
                showResult('sms-compose-result', 'AppId validated! Redirecting to SMS compose view...', 'success');
                
                // Small delay to show the message, then redirect
                setTimeout(() => {
                    const smsComposeUrl = `/sms-compose?appId=${encodeURIComponent(app.appId)}&returnUrl=${encodeURIComponent(window.location.href)}`;
                    window.location.href = smsComposeUrl;
                }, 1500);
                
            } catch (error) {
                console.error('SMS compose error:', error);
                showResult('sms-compose-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('sms-compose-btn', 'Compose SMS');
            }
        }
        
        async function composeSmsWithPrefill() {
            const app = apps[currentApp];
            hideResult('sms-compose-prefill-result');
            showLoading('sms-compose-prefill-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Pre-fill data for testing - using the same phone numbers as test 2f
                const phoneNumbers = ['+16509064337', '+18083540490'];
                const message = 'Test SMS message from Mail Service! This is a pre-filled message to test the SMS compose functionality.';
                
                // Show success message and redirect
                showResult('sms-compose-prefill-result', 'AppId validated! Redirecting to SMS compose view with pre-filled data...', 'success');
                
                // Small delay to show the message, then redirect
                setTimeout(() => {
                    const smsComposeUrl = `/sms-compose?appId=${encodeURIComponent(app.appId)}&phoneNumbers=${encodeURIComponent(JSON.stringify(phoneNumbers))}&message=${encodeURIComponent(message)}&returnUrl=${encodeURIComponent(window.location.href)}`;
                    window.location.href = smsComposeUrl;
                }, 1500);
                
            } catch (error) {
                console.error('SMS compose with prefill error:', error);
                showResult('sms-compose-prefill-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('sms-compose-prefill-btn', 'Compose SMS (Pre-filled)');
            }
        }
        
        async function sendSmsWithAPI() {
            const app = apps[currentApp];
            hideResult('send-sms-api-result');
            showLoading('send-sms-api-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Get authentication token
                const authToken = await getAuthToken();
                if (!authToken) {
                    throw new Error('Failed to get authentication token');
                }
                
                // Test SMS data - using multiple phone numbers
                const testPhoneNumbers = ['+16509064337', '+18083540490'];
                const testMessage = 'Test SMS from Mail Service API! This message was sent to multiple recipients via the /api/sms/send endpoint.';
                
                const response = await fetch('/api/sms/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken
                    },
                    body: JSON.stringify({
                        appId: app.appId,
                        phoneNumbers: testPhoneNumbers,
                        message: testMessage
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let successMessage = `✅ Bulk SMS sent successfully via API!<br /><br />` +
                        `Total Recipients: ${result.summary.total}<br />` +
                        `Successful: ${result.summary.successful}<br />` +
                        `Failed: ${result.summary.failed}<br /><br />`;
                    
                    // Add details for each recipient
                    result.results.forEach((r, index) => {
                        successMessage += `${index + 1}. ${r.phoneNumber}: `;
                        if (r.success) {
                            successMessage += `✅ Sent (ID: ${r.messageId})<br />`;
                        } else {
                            successMessage += `❌ Failed (${r.error})<br />`;
                        }
                    });
                    
                    successMessage += `<br />Note: These SMS messages were sent using real Twilio service.`;
                    
                    showResult('send-sms-api-result', successMessage, 'success');
                } else {
                    throw new Error(result.message || 'SMS API call failed');
                }
                
            } catch (error) {
                console.error('Send SMS API error:', error);
                showResult('send-sms-api-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('send-sms-api-btn', 'Send SMS via API');
            }
        }

        // Helper function to get authentication token
        async function getAuthToken() {
            try {
                // Always use secure app authentication with client secrets
                const app = apps[currentApp];
                
                if (!app.clientSecret) {
                    throw new Error(`No client secret configured for ${app.name}. This app cannot use secure authentication.`);
                }
                
                const response = await fetch('/api/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        appId: app.appId,
                        clientSecret: app.clientSecret,
                        type: 'application'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`✅ Secure authentication successful for ${app.name}`);
                    return `Bearer ${data.token}`;
                } else {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(`Authentication failed: ${errorData?.message || response.statusText}`);
                }
                
            } catch (error) {
                console.error('❌ Secure authentication error:', error);
                throw error;
            }
        }
        
        async function manageApplications() {
            const app = apps[currentApp];
            hideResult('manage-apps-result');
            showLoading('manage-apps-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Show success message and redirect
                showResult('manage-apps-result', 'AppId validated! Redirecting to admin view...', 'success');
                
                // Small delay to show the message, then redirect
                setTimeout(() => {
                    const adminUrl = `/admin?appId=${encodeURIComponent(app.appId)}&returnUrl=${encodeURIComponent(window.location.href)}`;
                    window.location.href = adminUrl;
                }, 1500);
                
            } catch (error) {
                console.error('Manage applications error:', error);
                showResult('manage-apps-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('manage-apps-btn', 'Manage Applications');
            }
        }
        
        async function viewEmailLogs() {
            const app = apps[currentApp];
            hideResult('email-logs-result');
            showLoading('email-logs-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Show success message and redirect
                showResult('email-logs-result', 'AppId validated! Redirecting to email logs view...', 'success');
                
                // Small delay to show the message, then redirect
                setTimeout(() => {
                    const logsUrl = `/email-logs?appId=${encodeURIComponent(app.appId)}&returnUrl=${encodeURIComponent(window.location.href)}`;
                    window.location.href = logsUrl;
                }, 1500);
                
            } catch (error) {
                console.error('View email logs error:', error);
                showResult('email-logs-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('email-logs-btn', 'View Email Logs');
            }
        }
        
        async function viewSmsLogs() {
            const app = apps[currentApp];
            hideResult('sms-logs-result');
            showLoading('sms-logs-btn');
            
            try {
                // Validate the appId exists by checking if it's in our valid apps list
                if (!app || !app.appId) {
                    throw new Error('Invalid application selected');
                }
                
                // Show success message and redirect
                showResult('sms-logs-result', 'AppId validated! Redirecting to SMS logs view...', 'success');
                
                // Small delay to show the message, then redirect
                setTimeout(() => {
                    const smsLogsUrl = `/sms-logs?appId=${encodeURIComponent(app.appId)}&returnUrl=${encodeURIComponent(window.location.href)}`;
                    window.location.href = smsLogsUrl;
                }, 1500);
                
            } catch (error) {
                console.error('View SMS logs error:', error);
                showResult('sms-logs-result', `Error: ${error.message}`, 'error');
            } finally {
                hideLoading('sms-logs-btn', 'View SMS Logs');
            }
        }
        
        // Authentication management functions
        function clearAuthTokens() {
            hideResult('auth-status-result');
            showLoading('clear-token-btn');
            
            try {
                // Clear all authentication-related localStorage items used by mail-service UI
                const keysToRemove = [
                    'authToken',
                    'userToken', 
                    'appToken',
                    'appId',
                    'tenantId',
                    'user',
                    'roles',
                    'tokenExpiry',
                    'lastAuthCheck',
                    'currentView',
                    'viewState'
                ];
                
                let removedKeys = [];
                keysToRemove.forEach(key => {
                    if (localStorage.getItem(key) !== null) {
                        localStorage.removeItem(key);
                        removedKeys.push(key);
                    }
                });
                
                // Also clear sessionStorage items
                keysToRemove.forEach(key => {
                    if (sessionStorage.getItem(key) !== null) {
                        sessionStorage.removeItem(key);
                        removedKeys.push(`${key} (session)`);
                    }
                });
                
                const message = removedKeys.length > 0 
                    ? `Cleared authentication tokens: ${removedKeys.join(', ')}`
                    : 'No authentication tokens found to clear';
                    
                showResult('auth-status-result', message, 'success');
                
            } catch (error) {
                console.error('Clear tokens error:', error);
                showResult('auth-status-result', `Error clearing tokens: ${error.message}`, 'error');
            } finally {
                hideLoading('clear-token-btn', 'Clear Auth Tokens');
            }
        }
        
        function checkAuthStatus() {
            hideResult('auth-status-result');
            showLoading('check-token-btn');
            
            try {
                const authItems = [
                    'authToken',
                    'userToken', 
                    'appToken',
                    'appId',
                    'tenantId',
                    'user',
                    'roles'
                ];
                
                let statusInfo = [];
                authItems.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value !== null) {
                        if (key === 'authToken' || key === 'userToken' || key === 'appToken') {
                            // For tokens, just show if they exist and length
                            statusInfo.push(`${key}: present (${value.length} chars)`);
                        } else {
                            // For other items, show the actual value (but truncate if too long)
                            const displayValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
                            statusInfo.push(`${key}: ${displayValue}`);
                        }
                    }
                });
                
                const message = statusInfo.length > 0 
                    ? `Current auth state:\n${statusInfo.join('\n')}`
                    : 'No authentication tokens found in localStorage';
                    
                showResult('auth-status-result', message, 'info');
                
            } catch (error) {
                console.error('Check auth status error:', error);
                showResult('auth-status-result', `Error checking auth status: ${error.message}`, 'error');
            } finally {
                hideLoading('check-token-btn', 'Check Auth Status');
            }
        }
        
        // Test external app flow with URL parameters
        function testExternalAppFlow() {
            hideResult('auth-status-result');
            showLoading('test-external-flow-btn');
            
            try {
                // First clear all tokens to ensure we go through IDP
                const keysToRemove = [
                    'authToken',
                    'userToken', 
                    'appToken',
                    'appId',
                    'tenantId',
                    'user',
                    'roles',
                    'tokenExpiry',
                    'lastAuthCheck',
                    'currentView',
                    'viewState'
                ];
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                showResult('auth-status-result', 'Cleared tokens, redirecting to mail-service with URL parameters...', 'success');
                
                // Simulate coming from ReTree Hawaii with URL parameters
                const testUrl = 'http://localhost:3100/ui?' + 
                    'view=compose' +
                    '&appId=cmfka688r0001b77ofpgm57ix' +
                    '&recipients=test@example.com,another@example.com' +
                    '&subject=Test Subject' +
                    '&returnUrl=' + encodeURIComponent(window.location.origin + '/test-app.html');
                
                // Small delay to let the user see the message
                setTimeout(() => {
                    window.location.href = testUrl;
                }, 1000);
                
            } catch (error) {
                console.error('Test external flow error:', error);
                showResult('auth-status-result', `Error: ${error.message}`, 'error');
                hideLoading('test-external-flow-btn', 'Test External App Flow');
            }
        }
        
        // Handle return from mail-service with status
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            const message = urlParams.get('message');
            const action = urlParams.get('action');
            
            if (status && message && action) {
                let resultElementId = '';
                switch (action) {
                    case 'compose':
                        resultElementId = 'compose-message-result';
                        break;
                    case 'sms-compose':
                        resultElementId = 'sms-compose-result';
                        break;
                    case 'admin':
                        resultElementId = 'manage-apps-result';
                        break;
                    case 'email-logs':
                        resultElementId = 'email-logs-result';
                        break;
                    case 'sms-logs':
                        resultElementId = 'sms-logs-result';
                        break;
                }
                
                if (resultElementId) {
                    const resultType = status === 'success' ? 'success' : 'error';
                    showResult(resultElementId, decodeURIComponent(message), resultType);
                    
                    // Clean up URL parameters
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                }
            }
        });
    </script>
</body>
</html>