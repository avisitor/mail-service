<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mail Service - Compose</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/ui/styles.css" />
</head>
<body>
  <div id="app">
    <header>
      <h1 id="viewTitle">Mail Service</h1>
      <nav class="topnav">
        <button data-view="tenants" class="navBtn">Tenants</button>
        <button data-view="compose" class="navBtn">Compose</button>
        <button data-view="smtp-config" class="navBtn">SMTP Config</button>
      </nav>
      <div class="env" id="envInfo"></div>
      <div class="userPane" id="userPane" style="display:none">
        <span id="userSummary"></span>
        <button id="logoutBtn" class="smallBtn" type="button">Logout</button>
      </div>
    </header>
    <main class="layout" id="view-tenants" style="display:none">
      <section class="panel fullwidth">
        <h2>Tenants</h2>
        <form id="tenantForm">
          <label>New Tenant Name <input name="tenantName" placeholder="Tenant A" required /></label>
          <button type="submit">Create Tenant</button>
          <div class="status" id="tenantStatus"></div>
        </form>
        <div id="tenantList"></div>
      </section>
    </main>
    <main class="layout" id="view-compose">
      <section class="panel" id="tenantAppPanel">
        <h2>Context</h2>
        <div class="sub">
          <label>Tenant <select id="tenantSelect"></select></label>
        </div>
        <div class="sub">
          <label>App <select id="appSelect"></select></label>
        </div>
        <div style="margin-top:8px">
          <button type="button" id="goToTenantsBtn" class="smallBtn">Manage Tenants & Apps</button>
        </div>
        <div class="status" id="appStatus"></div>
      </section>
      <section class="panel">
        <h2>Template</h2>
        <form id="templateForm">
          <label>Name <input name="name" required placeholder="welcome" /></label>
          <label>Version <input name="version" type="number" value="1" min="1" required /></label>
          <label>Subject <input name="subject" required placeholder="Hello {{name}}" /></label>
          <label>Body (HTML)
            <textarea name="bodyHtml" rows="6" placeholder="<p>Hi {{name}}</p>"></textarea>
          </label>
          <label>Body (Text)
            <textarea name="bodyText" rows="4" placeholder="Hi {{name}}"></textarea>
          </label>
          <label>Variables (JSON)
            <textarea name="variables" rows="3" placeholder="{ }"></textarea>
          </label>
          <button type="submit">Save Template</button>
          <div class="status" id="templateStatus"></div>
        </form>
        <div id="templateList"></div>
        <div style="margin-top:8px">
          <button id="deactivateTemplateBtn" type="button" disabled>Deactivate Template</button>
        </div>
      </section>
      <section class="panel">
        <h2>Render Preview</h2>
        <form id="renderForm">
          <label>Context (JSON)
            <textarea name="context" rows="6" placeholder='{"name":"Alice"}'></textarea>
          </label>
          <button type="submit">Render</button>
          <div class="status" id="renderStatus"></div>
        </form>
        <div class="preview">
          <h3>Subject</h3>
          <div id="previewSubject" class="code"></div>
          <h3>HTML</h3>
            <iframe id="previewHtml"></iframe>
          <h3>Text</h3>
          <pre id="previewText" class="code"></pre>
        </div>
      </section>
      <section class="panel">
  <h2>Send Group</h2>
        <form id="groupForm">
          <label>Group Subject <input name="groupSubject" placeholder="Announcement" required /></label>
          <label>Recipients (CSV emails, one per line)
            <textarea name="recipients" rows="6" placeholder="user1@example.com\nuser2@example.com"></textarea>
          </label>
          <button type="submit">Create + Send (Dry Run)</button>
          <div class="status" id="groupStatus"></div>
        </form>
        <div id="groupEvents"></div>
          <div style="margin-top:8px">
            <button id="cancelGroupBtn" type="button" disabled>Cancel Group</button>
          </div>
      </section>
      <section class="panel" id="activityPanel">
        <h2>Recent Groups</h2>
        <div id="groupsList" class="code" style="max-height:180px;overflow:auto"></div>
        <h3 style="margin-top:12px">Group Events</h3>
        <div id="eventsList" class="code" style="max-height:200px;overflow:auto"></div>
      </section>
      <section class="panel">
        <h2>Quick Send (No Template)</h2>
        <form id="quickSendForm">
          <label>Subject <input name="qsSubject" placeholder="Hello" required /></label>
          <label>HTML Body
            <textarea name="qsHtml" rows="6" placeholder="<p>Hello world</p>"></textarea>
          </label>
          <label>Text Body
            <textarea name="qsText" rows="4" placeholder="Hello world"></textarea>
          </label>
          <label>Recipients (emails, one per line)
            <textarea name="qsRecipients" rows="5" placeholder="user@example.com"></textarea>
          </label>
          <button type="submit">Send Now</button>
          <div class="status" id="quickSendStatus"></div>
        </form>
      </section>
    </main>
    <main class="layout" id="view-smtp-config" style="display:none">
      <section class="panel fullwidth" id="roleSimulator" style="background: #2a2a2a; border: 1px solid #555; margin-bottom: 15px;">
        <h3 style="margin-top: 0; color: #ffa500;">Role Simulator (Testing Only)</h3>
        <div class="grid" style="grid-template-columns: auto auto auto auto; gap: 15px; align-items: center;">
          <label>Role:
            <select id="roleSelect" style="width: 150px;">
              <option value="super-admin">Super Admin</option>
              <option value="tenant-admin">Tenant Admin</option>
              <option value="app-user">App User</option>
            </select>
          </label>
          <label id="tenantSelectLabel" style="visibility: hidden;">Tenant:
            <select id="roleTenantSelect" style="width: 200px;">
              <option value="">Select Tenant...</option>
            </select>
          </label>
          <label id="appSelectLabel" style="visibility: hidden;">App:
            <select id="roleAppSelect" style="width: 200px;">
              <option value="">Select App...</option>
            </select>
          </label>
          <button type="button" id="applyRoleBtn" class="config-btn">Apply Role</button>
        </div>
        <div id="roleStatus" style="margin-top: 10px; font-size: 0.9em; color: #ccc;"></div>
      </section>
      
      <section class="panel fullwidth">
        <h2>SMTP Configuration Hierarchy</h2>
        <div id="smtpTree" style="margin-bottom: 20px;">
          <div class="tree-loading">Loading configuration tree...</div>
        </div>
      </section>
      
      <section class="panel fullwidth" id="smtpConfigEditor" style="display:none">
        <h2 id="configEditorTitle">Configuration Editor</h2>
        <div class="config-actions" style="margin-bottom: 15px;">
          <button type="button" id="addGlobalBtn" class="config-btn">Add Global Config</button>
          <button type="button" id="addTenantBtn" class="config-btn" style="display:none">Add Tenant Config</button>
          <button type="button" id="addAppBtn" class="config-btn" style="display:none">Add App Config</button>
          <button type="button" id="cancelEditBtn" class="config-btn config-btn-secondary">Cancel</button>
        </div>
        <h2>Manage Configurations</h2>
        
        <form id="smtpConfigForm">
          <input type="hidden" name="scope" id="configScope" />
          <input type="hidden" name="tenantId" id="configTenantId" />
          <input type="hidden" name="appId" id="configAppId" />
          
          <fieldset>
            <legend>Service Configuration</legend>
            <div class="grid">
              <label>Service Type
                <select name="service" id="serviceSelect">
                  <option value="smtp">SMTP</option>
                  <option value="ses">Amazon SES</option>
                </select>
              </label>
            </div>
            
            <!-- SMTP-specific fields -->
            <div id="smtpFields">
              <div class="grid">
                <label>Host <input name="host" placeholder="smtp.example.com" /></label>
                <label>Port <input name="port" type="number" value="587" /></label>
                <label>
                  <input name="secure" type="checkbox" /> Use TLS/SSL
                </label>
              </div>
              <div class="grid">
                <label>Username <input name="user" placeholder="Optional" /></label>
                <label>Password <input name="pass" type="password" placeholder="Optional" /></label>
              </div>
            </div>
            
            <!-- SES-specific fields -->
            <div id="sesFields" style="display:none">
              <div class="grid">
                <label>AWS Region <input name="awsRegion" placeholder="us-east-1" /></label>
                <label>AWS Access Key <input name="awsAccessKey" placeholder="AKIA..." /></label>
                <label>AWS Secret Key <input name="awsSecretKey" type="password" placeholder="Secret key" /></label>
              </div>
            </div>
            
            <!-- Common fields for both services -->
            <div class="grid">
              <label>From Address <input name="fromAddress" type="email" placeholder="noreply@example.com" /></label>
              <label>From Name <input name="fromName" placeholder="Mail Service" /></label>
            </div>
          </fieldset>
          
          <div class="config-form-actions" style="margin-top: 15px;">
            <button type="submit" id="saveConfigBtn">Save Configuration</button>
            <button type="button" id="deleteConfigBtn" class="config-btn config-btn-danger" style="display:none">Delete</button>
            <button type="button" id="testConfigBtn" class="config-btn config-btn-secondary">Test Configuration</button>
          </div>
          
          <div class="status" id="smtpConfigStatus"></div>
        </form>
      </section>
    </main>
  </div>
  <div id="loginOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:1000">
    <div style="background:#1e1e1e;padding:24px;max-width:480px;width:100%;border:1px solid #444;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.5);">
      <h2 style="margin-top:0">Authenticate</h2>
      <p style="font-size:.9rem;line-height:1.3">Paste a JWT (Bearer token). It must be signed by the configured issuer and include roles claim. Stored only in localStorage.</p>
      <form id="loginForm">
        <label style="display:block;margin-bottom:8px">Token
          <textarea name="token" rows="5" style="width:100%;font-family:monospace" placeholder="eyJhbGciOiJSUzI1NiIs..." required></textarea>
        </label>
        <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
          <button type="submit">Use Token</button>
          <button type="button" id="loginCancelBtn" class="smallBtn" style="display:none">Cancel</button>
          <span id="loginStatus" class="status" style="flex:1;text-align:right"></span>
        </div>
      </form>
      <details style="margin-top:12px">
        <summary style="cursor:pointer">Dev Helper</summary>
        <p style="font-size:.8rem">If you generated a local key, mint a token in another terminal:<br/><code>npm run token -- --roles superadmin</code></p>
      </details>
    </div>
  </div>
  <!-- Use compiled JS under /ui/ (dist build places main.js there). -->
  <script type="module" src="/ui/main.js"></script>
</body>
</html>
