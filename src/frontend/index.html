<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mail Service - Compose</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/ui/styles.css" />
  <script src="https://cdn.tiny.cloud/1/pm0hwd9ezk1wqe3lvzr86js295g5qcq1vp2pbzgzm0fpbluh/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
  <div id="app">
    <header>
      <h1 id="viewTitle">Mail Service</h1>
      <nav class="topnav">
        <button data-view="tenants" class="navBtn" id="tenantsNavBtn" style="display:none">Tenants</button>
        <button data-view="apps" class="navBtn" id="appsNavBtn" style="display:none">Apps</button>
        <button data-view="compose" class="navBtn">Compose</button>
        <button data-view="sms-compose" class="navBtn">Send SMS</button>
        <button data-view="template-editor" class="navBtn" id="templateEditorNavBtn" style="display:none">Templates</button>
        <button data-view="smtp-config" class="navBtn">SMTP Config</button>
        <button data-view="sms-config" class="navBtn">SMS Config</button>
      </nav>
      <div class="env" id="envInfo"></div>
      <div id="roleContext" style="background: #2a2a2a; padding: 8px; margin: 4px 0; border: 1px solid #555; border-radius: 4px; display: none;">
        <div id="roleContextInfo" style="font-size: 0.9em; color: #ccc; margin-bottom: 8px;"></div>
        <div id="roleContextActions" style="display: flex; gap: 8px; align-items: center;">
          <button id="switchContextBtn" class="smallBtn" style="display:none">Switch Context</button>
          <button id="returnSuperadminBtn" class="smallBtn" style="display:none">Return to Superadmin</button>
        </div>
      </div>
      <div class="userPane" id="userPane" style="display:none">
        <span id="userSummary"></span>
        <button id="logoutBtn" class="smallBtn" type="button" style="background: #dc3545; border: 1px solid #dc3545; color: white; margin-left: 10px;" title="Logout and clear session">🚪 Logout</button>
      </div>
    </header>
    <main class="layout" id="view-tenants" style="display:none">
      <section class="panel fullwidth">
        <h2>Tenants</h2>
        <form id="tenantForm">
          <label>New Tenant Name <input name="tenantName" placeholder="Tenant A" required /></label>
          <button type="submit">Create Tenant</button>
          <div class="status" id="tenantStatus"></div>
        </form>
        <div id="tenantList"></div>
      </section>
    </main>
    <main class="layout" id="view-apps" style="display:none">
      <section class="panel fullwidth">
        <h2>Application Management</h2>
        <div id="appContextInfo" style="background: #2a2a2a; padding: 12px; margin-bottom: 15px; border: 1px solid #555; border-radius: 4px;">
          <div id="appTenantContext" style="color: #ccc; font-size: 0.9em;"></div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <button type="button" id="createAppBtn" class="config-btn config-btn-primary">+ Create Application</button>
        </div>
        
        <form id="appForm" style="margin-bottom: 20px; display: none;">
          <div class="grid" style="grid-template-columns: 1fr auto auto; gap: 10px; align-items: end;">
            <label>App Name <input name="appName" placeholder="My Application" required /></label>
            <button type="submit">Create Application</button>
            <button type="button" id="cancelAppBtn" class="config-btn config-btn-secondary">Cancel</button>
          </div>
          <div class="status" id="appFormStatus"></div>
        </form>
        
        <div id="appsList" style="margin-top: 20px;">
          <div class="loading">Loading applications...</div>
        </div>
      </section>
    </main>
    <main class="layout" id="view-compose">
      <div class="compose-container">
        <form id="composeForm" class="mail-fields">
          <!-- Send Mode Selection -->
          <div class="form-group">
            <label for="sendMode">Send Mode</label>
            <select id="sendMode" class="form-control">
              <option value="individual">Individual messages (each recipient gets separate email)</option>
              <option value="cc">Group with CC (all recipients visible to each other)</option>
              <option value="bcc">Group with BCC (recipients hidden from each other)</option>
            </select>
          </div>
          
          <!-- Recipients -->
          <div class="form-group">
            <label for="recipients">To (one line per recipient)</label>
            <textarea id="recipients" class="form-control" rows="5" cols="20" name="recipients" placeholder="user1@example.com&#10;John Doe &lt;user2@example.com&gt;&#10;user3@example.com"></textarea>
            <span>&nbsp;<span id="addressCount">0</span> recipients</span>
          </div>
          
          <!-- From -->
          <div class="form-group">
            <label for="fromAddress">From</label>
            <input type="text" name="fromAddress" id="fromAddress" class="form-control" placeholder="Loading from SMTP config...">
          </div>
          
          <!-- Subject -->
          <div class="form-group">
            <label for="subject">Subject</label>
            <input type="text" name="subject" id="subject" class="form-control" placeholder="Enter subject">
          </div>
          
          <!-- Schedule Send Time -->
          <div class="form-group">
            <label for="datetime">Date/Time to send (empty for immediate, e.g. 5pm for a later time)</label>
            <input type="datetime-local" name="datetime" id="datetime" class="form-control">
          </div>
          
          <!-- Template Selection -->
          <div class="form-group">
            <label for="templateSelect">Optional: Select template (replaces message content)</label>
            <select id="templateSelect" class="form-control">
              <option value="">-- Select a template --</option>
            </select>
          </div>
          
          <!-- Previous Message Selection -->
          <div class="form-group">
            <label for="previousMessageSelect">Optional: Select previously sent mail (replaces message content)</label>
            <select id="previousMessageSelect" class="form-control">
              <option value="">-- Select previous message --</option>
            </select>
          </div>
          
          <!-- Content -->
          <div class="form-group">
            <label for="messageContent">Content</label>
            
            <!-- TinyMCE Editor -->
            <textarea id="messageContent" 
                     name="messageContent"
                     class="form-control" 
                     style="min-height: 300px;"
                     placeholder="Enter your message content here"></textarea>
            
            <!-- Hidden textarea for form submission -->
            <textarea id="messageContentHidden" name="messageContent" style="display: none;"></textarea>
          </div>
          
          <!-- File Attachments -->
          <div class="form-group">
            <label for="attachments">Attach files:</label>
            <input id="attachments" name="attachments" type="file" multiple />
          </div>
          
          <!-- Test Send -->
          <div class="form-group">
            <div class="test-send-row">
              <input type="button" class="btn btn-secondary" id="sendTestBtn" value="Send test"> 
              <label for="testRecipient">to:</label> 
              <input type="text" class="form-control" id="testRecipient" placeholder="test@example.com">
            </div>
          </div>
          
          <!-- Send Mail -->
          <div class="form-group">
            <div style="display: flex; gap: 10px; align-items: center;">
              <input type="submit" class="btn btn-primary" value="Send mail">
              <button type="button" class="btn btn-secondary" onclick="clearDraft()" title="Clear the current draft and saved state">Clear Draft</button>
            </div>
          </div>
          
          <!-- Status Messages -->
          <div class="status" id="composeStatus"></div>
        </form>
      </div>
    </main>
    <main class="layout" id="view-template-editor" style="display:none">
      <div class="compose-container">
        <form id="templateEditorForm" class="mail-fields">
          <!-- Template Selection -->
          <div class="form-group">
            <label for="templateEditorSelect">Select Template to Edit</label>
            <select id="templateEditorSelect" class="form-control">
              <option value="">-- Create New Template --</option>
            </select>
          </div>
          
          <!-- Template Title -->
          <div class="form-group">
            <label for="templateTitle">Title</label>
            <input type="text" name="templateTitle" id="templateTitle" class="form-control" placeholder="Enter template title" required>
          </div>
          
          <!-- Template Subject -->
          <div class="form-group">
            <label for="templateSubject">Subject</label>
            <input type="text" name="templateSubject" id="templateSubject" class="form-control" placeholder="Enter subject template (use ${variable} for substitution)">
          </div>
          
          <!-- Template Content -->
          <div class="form-group">
            <label for="templateContent">Content</label>
            
            <!-- TinyMCE Editor -->
            <textarea id="templateContent" 
                     name="templateContent"
                     class="form-control" 
                     style="min-height: 300px;"
                     placeholder="Enter your template content here. Use ${variable} for variable substitution."></textarea>
            
            <!-- Hidden textarea for form submission -->
            <textarea id="templateContentHidden" name="templateContent" style="display: none;"></textarea>
          </div>
          
          <!-- Template Actions -->
          <div class="form-group">
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button type="button" id="saveNewTemplateBtn" class="btn btn-primary">Save as New</button>
              <button type="button" id="updateTemplateBtn" class="btn btn-secondary" style="display: none;">Update Existing</button>
              <button type="button" id="deleteTemplateBtn" class="btn btn-danger" style="display: none;">Delete Template</button>
              <button type="button" id="cancelTemplateEditBtn" class="btn btn-secondary">Cancel</button>
            </div>
          </div>
          
          <!-- Status Messages -->
          <div class="status" id="templateEditorStatus"></div>
        </form>
      </div>
    </main>
    <main class="layout" id="view-sms-compose" style="display:none">
      <div class="compose-container">
        <div style="background: #2a2a2a; padding: 12px; margin-bottom: 15px; border: 1px solid #555; border-radius: 4px;">
          <h2 style="margin: 0; color: #4fc3f7;">📱 Send SMS</h2>
          <div id="smsAppContext" style="color: #ccc; font-size: 0.9em; margin-top: 4px;"></div>
        </div>
        
        <form id="smsComposeForm" class="mail-fields">
          <!-- Phone Numbers -->
          <div class="form-group">
            <label for="phoneNumbers">Phone numbers to send to (one per line)</label>
            <textarea id="phoneNumbers" class="form-control" rows="5" cols="20" name="phoneNumbers" placeholder="+1-555-123-4567&#10;+1-555-987-6543&#10;15551234567"></textarea>
            <span>&nbsp;<span id="phoneCount">0</span> recipients</span>
          </div>
          
          <!-- Message Content -->
          <div class="form-group">
            <label for="smsMessage">Message to send</label>
            <textarea id="smsMessage" 
                     name="smsMessage"
                     class="form-control" 
                     rows="6"
                     maxlength="1600"
                     placeholder="Enter your SMS message here. Keep it concise - SMS has character limits."></textarea>
            <div style="font-size: 0.9em; color: #888; margin-top: 4px;">
              <span id="smsCharCount">0</span>/1600 characters
            </div>
          </div>
          
          <!-- SMS Actions -->
          <div class="form-group">
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button type="submit" class="btn btn-primary">Send SMS</button>
              <button type="button" id="cancelSmsBtn" class="btn btn-secondary">Cancel</button>
            </div>
          </div>
          
          <!-- Status Messages -->
          <div class="status" id="smsComposeStatus"></div>
        </form>
      </div>
    </main>
    <main class="layout" id="view-sms-config" style="display:none">
      <!-- Role Context Indicator -->
      <section class="panel fullwidth" id="smsRoleContextIndicator" style="background: #2a2a2a; border: 1px solid #555; margin-bottom: 15px; display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div>
            <span style="color: #81c784; font-weight: bold;">📋 Tenant Context:</span>
            <span id="smsContextTenantName" style="color: #fff; margin-left: 8px;"></span>
          </div>
          <button id="smsExitContextBtn" class="config-btn config-btn-secondary">← Back to Superadmin</button>
        </div>
      </section>

      <!-- Global SMS Configuration Management -->
      <section class="panel fullwidth" id="smsGlobalConfigSection">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <h2 style="margin: 0; color: #4fc3f7;">📱 Global SMS Configurations</h2>
          <button id="addGlobalSmsConfigBtn" class="config-btn config-btn-primary">+ Add Global SMS Config</button>
        </div>
        
        <div id="globalSmsConfigCards" style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 24px;">
          <!-- Global SMS config cards will be populated here -->
        </div>
        
        <div id="noGlobalSmsConfigs" style="display: none; text-align: center; padding: 32px; color: #888; border: 2px dashed #444; border-radius: 8px;">
          <div style="font-size: 2rem; margin-bottom: 8px;">📱</div>
          <p style="margin: 0; font-size: 1.1rem; font-weight: bold;">No global SMS configurations yet</p>
          <p style="margin: 8px 0 0 0; font-size: 0.9rem;">Global configs provide fallback SMS service for all tenants</p>
        </div>
      </section>
      
      <!-- Tenant SMS Overview Section -->
      <section class="panel fullwidth" id="smsTenantOverviewSection">
        <h2 style="margin: 0 0 16px 0; color: #81c784;">🏢 Tenant SMS Configuration Overview</h2>
        <div id="smsConfigTree" style="font-family: monospace; font-size: 14px; line-height: 1.6; white-space: pre; background: #1a1a1a; padding: 16px; border-radius: 6px; border: 1px solid #333;">
          <div class="tree-loading">Loading SMS configuration tree...</div>
        </div>
        
        <div style="margin-top: 12px; font-size: 0.9rem; color: #999; display: flex; align-items: center; gap: 8px;">
          <span>💡</span>
          <span><strong>Tip:</strong> Click on any tenant name to switch context and manage their specific SMS configuration</span>
        </div>
      </section>

      <!-- Legacy SMS Config Editor (hidden, for backward compatibility) -->
      <section class="panel fullwidth" id="smsConfigEditor" style="display:none">
        <h2 id="smsConfigEditorTitle">SMS Configuration Editor</h2>
        <div class="config-actions" style="margin-bottom: 15px;">
          <button type="button" id="addGlobalSmsBtn" class="config-btn">Add Global SMS Config</button>
          <button type="button" id="addTenantSmsBtn" class="config-btn" style="display:none">Add Tenant SMS Config</button>
          <button type="button" id="addAppSmsBtn" class="config-btn" style="display:none">Add App SMS Config</button>
          <button type="button" id="cancelEditSmsBtn" class="config-btn config-btn-secondary">Cancel</button>
        </div>
        
        <form id="smsConfigForm">
          <input type="hidden" name="scope" id="smsConfigScope" />
          <input type="hidden" name="tenantId" id="smsConfigTenantId" />
          <input type="hidden" name="appId" id="smsConfigAppId" />
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <div class="form-group">
                <label for="smsSid">Twilio Account SID</label>
                <input type="text" name="sid" id="smsSid" class="form-control" placeholder="Account SID" required>
              </div>
              
              <div class="form-group">
                <label for="smsToken">Twilio Auth Token</label>
                <input type="password" name="token" id="smsToken" class="form-control" placeholder="Auth Token" required>
              </div>
              
              <div class="form-group">
                <label for="smsFromNumber">From Phone Number</label>
                <input type="tel" name="fromNumber" id="smsFromNumber" class="form-control" placeholder="+1234567890" required>
              </div>
            </div>
            
            <div>
              <div class="form-group">
                <label for="smsFallbackTo">Fallback Phone Number (Optional)</label>
                <input type="tel" name="fallbackTo" id="smsFallbackTo" class="form-control" placeholder="+1234567890">
              </div>
              
              <div class="form-group">
                <label for="smsServiceSid">Messaging Service SID (Optional)</label>
                <input type="text" name="serviceSid" id="smsServiceSid" class="form-control" placeholder="Messaging Service SID">
              </div>
              
              <div class="form-group">
                <label>
                  <input type="checkbox" name="isActive" id="smsIsActive" checked> Active Configuration
                </label>
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save SMS Configuration</button>
            <button type="button" id="deleteSmsConfigBtn" class="btn btn-danger" style="display:none">Delete</button>
            <button type="button" id="testSmsConfigBtn" class="btn btn-secondary">Test Configuration</button>
          </div>
        </form>
      </section>
    </main>
    <main class="layout" id="view-smtp-config" style="display:none">
      <!-- Role Context Indicator -->
      <section class="panel fullwidth" id="roleContextIndicator" style="background: #2a2a2a; border: 1px solid #555; margin-bottom: 15px; display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div>
            <span style="color: #81c784; font-weight: bold;">📋 Tenant Context:</span>
            <span id="contextTenantName" style="color: #fff; margin-left: 8px;"></span>
          </div>
          <button id="exitContextBtn" class="config-btn config-btn-secondary">← Back to Superadmin</button>
        </div>
      </section>

      <!-- Global Configuration Management -->
      <section class="panel fullwidth" id="globalConfigSection">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <h2 style="margin: 0; color: #4fc3f7;">🌐 Global SMTP Configurations</h2>
          <button id="addGlobalConfigBtn" class="config-btn config-btn-primary">+ Add Global Config</button>
        </div>
        
        <div id="globalConfigCards" style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 24px;">
          <!-- Global config cards will be populated here -->
        </div>
        
        <div id="noGlobalConfigs" style="display: none; text-align: center; padding: 32px; color: #888; border: 2px dashed #444; border-radius: 8px;">
          <div style="font-size: 2rem; margin-bottom: 8px;">📧</div>
          <p style="margin: 0; font-size: 1.1rem; font-weight: bold;">No global SMTP configurations yet</p>
          <p style="margin: 8px 0 0 0; font-size: 0.9rem;">Global configs provide fallback email service for all tenants</p>
        </div>
      </section>
      
      <!-- Tenant Overview Section -->
      <section class="panel fullwidth" id="tenantOverviewSection">
        <h2 style="margin: 0 0 16px 0; color: #81c784;">🏢 Tenant Configuration Overview</h2>
        <div id="smtpTree" style="font-family: monospace; font-size: 14px; line-height: 1.6; white-space: pre; background: #1a1a1a; padding: 16px; border-radius: 6px; border: 1px solid #333;">
          <div class="tree-loading">Loading configuration tree...</div>
        </div>
        
        <div style="margin-top: 12px; font-size: 0.9rem; color: #999; display: flex; align-items: center; gap: 8px;">
          <span>💡</span>
          <span><strong>Tip:</strong> Click on any tenant name to switch context and manage their specific configuration</span>
        </div>
      </section>

      <!-- Legacy Config Editor (hidden, for backward compatibility) -->
      <section class="panel fullwidth" id="smtpConfigEditor" style="display:none">
        <h2 id="configEditorTitle">Configuration Editor</h2>
        <div class="config-actions" style="margin-bottom: 15px;">
          <button type="button" id="addGlobalBtn" class="config-btn">Add Global Config</button>
          <button type="button" id="addTenantBtn" class="config-btn" style="display:none">Add Tenant Config</button>
          <button type="button" id="addAppBtn" class="config-btn" style="display:none">Add App Config</button>
          <button type="button" id="cancelEditBtn" class="config-btn config-btn-secondary">Cancel</button>
        </div>
        
        <form id="smtpConfigForm">
          <input type="hidden" name="scope" id="configScope" />
          <input type="hidden" name="tenantId" id="configTenantId" />
          <input type="hidden" name="appId" id="configAppId" />
          
          <fieldset>
            <legend>Service Configuration</legend>
            <div class="grid">
              <label>Service Type
                <select name="service" id="smtpServiceSelect">
                  <option value="smtp">SMTP</option>
                  <option value="ses">Amazon SES</option>
                </select>
              </label>
            </div>
            <button type="submit" id="saveConfigBtn">Save Configuration</button>
            <button type="button" id="deleteConfigBtn" class="config-btn config-btn-danger" style="display:none">Delete</button>
            <button type="button" id="testConfigBtn" class="config-btn config-btn-secondary">Test Configuration</button>
          </fieldset>
          
          <div class="status" id="smtpConfigStatus"></div>
        </form>
      </section>
    </main>
    
    <!-- Global Configuration Modal -->
    <div id="globalConfigModal" style="position: fixed; inset: 0; background: rgba(0,0,0,.85); display: none; align-items: center; justify-content: center; z-index: 1000;">
      <div style="background: #1e1e1e; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid #444; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,.5);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <h2 id="globalConfigModalTitle" style="margin: 0;">Add Global SMTP Configuration</h2>
          <button id="closeGlobalConfigModal" style="background: transparent; border: none; color: #999; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
        </div>
        
        <form id="globalConfigForm">
          <input type="hidden" name="scope" value="GLOBAL" />
          <input type="hidden" name="configId" id="globalConfigId" />
          
          <fieldset>
            <legend>Service Configuration</legend>
            <div class="grid">
              <label>Service Type
                <select name="service" id="globalServiceSelect">
                  <option value="smtp">SMTP</option>
                  <option value="ses">Amazon SES</option>
                </select>
              </label>
            </div>
            
            <!-- SMTP-specific fields -->
            <div id="globalSmtpFields">
              <div class="grid">
                <label>Host <input name="host" placeholder="smtp.example.com" /></label>
                <label>Port <input name="port" type="number" value="587" /></label>
                <label>
                  <input name="secure" type="checkbox" /> Use TLS/SSL
                </label>
              </div>
              <div class="grid">
                <label>Username <input name="user" placeholder="Optional" /></label>
                <label>Password <input name="pass" type="password" placeholder="Optional" /></label>
              </div>
            </div>
            
            <!-- SES-specific fields -->
            <div id="globalSesFields" style="display:none">
              <div class="grid">
                <label>AWS Region <input name="awsRegion" placeholder="us-east-1" /></label>
                <label>AWS Access Key <input name="awsAccessKey" placeholder="AKIA..." /></label>
                <label>AWS Secret Key <input name="awsSecretKey" type="password" placeholder="Secret key" /></label>
              </div>
            </div>
            
            <!-- Common fields for both services -->
            <div class="grid">
              <label>From Address <input name="fromAddress" type="email" placeholder="noreply@example.com" /></label>
              <label>From Name <input name="fromName" placeholder="Mail Service" /></label>
            </div>
          </fieldset>
          
          <div class="config-form-actions" style="margin-top: 20px; display: flex; gap: 8px; flex-wrap: wrap;">
            <button type="submit" id="saveGlobalConfigBtn">Save Configuration</button>
            <button type="button" id="testGlobalConfigBtn" class="config-btn config-btn-secondary">Test Configuration</button>
            <button type="button" id="cancelGlobalConfigBtn" class="config-btn config-btn-secondary">Cancel</button>
            <button type="button" id="deleteGlobalConfigBtn" class="config-btn config-btn-danger" style="display: none; margin-left: auto;">Delete Configuration</button>
          </div>
          
          <div class="status" id="globalConfigStatus" style="margin-top: 12px;"></div>
        </form>
      </div>
    </div>
  </div>
  <div id="contextSwitchOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:1000">
    <div style="background:#1e1e1e;padding:24px;max-width:500px;width:100%;border:1px solid #444;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.5);">
      <h2 style="margin-top:0">Switch Context</h2>
      <p style="font-size:.9rem;line-height:1.3;color:#ccc">As a superadmin, you can switch to view the system from a specific tenant's perspective. This allows you to see and manage what a tenant admin would see.</p>
      
      <form id="contextSwitchForm">
        <label style="display:block;margin-bottom:16px">Select Tenant:
          <select name="contextTenantId" id="contextTenantSelect" style="width:100%;margin-top:4px" required>
            <option value="">-- Select Tenant --</option>
          </select>
        </label>
        
        <div style="display:flex;gap:8px;align-items:center;margin-top:16px">
          <button type="submit">Switch to Tenant Context</button>
          <button type="button" id="contextSwitchCancelBtn" class="smallBtn">Cancel</button>
          <span id="contextSwitchStatus" class="status" style="flex:1;text-align:right"></span>
        </div>
      </form>
    </div>
  </div>
  
  <!-- App SMTP Configuration Modal -->
  <div id="appConfigModal" style="position: fixed; inset: 0; background: rgba(0,0,0,.85); display: none; align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: #1e1e1e; padding: 24px; max-width: 600px; width: 100%; border: 1px solid #444; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,.5); max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 id="appConfigModalTitle" style="margin: 0;">Configure App SMTP</h2>
        <button id="closeAppConfigModal" style="background: transparent; border: none; color: #999; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
      </div>
      
      <form id="appConfigForm" style="display: flex; flex-direction: column; gap: 16px;">
        <div style="background: #2a2a2a; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
          <div style="font-weight: bold; color: #4CAF50;" id="appConfigAppName">App Name</div>
          <div style="font-size: 0.85em; color: #888; font-family: monospace;" id="appConfigAppId">App ID: app-123</div>
        </div>
        
        <label>
          Service Type
          <select id="appServiceSelect" name="service" required>
            <option value="smtp">SMTP</option>
            <option value="ses">Amazon SES</option>
          </select>
        </label>
        
        <div id="appSmtpFields">
          <label>
            SMTP Host
            <input type="text" name="host" placeholder="smtp.example.com" required>
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <label>
              Port
              <input type="number" name="port" placeholder="587" required>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 20px;">
              <input type="checkbox" name="secure">
              Use SSL/TLS
            </label>
          </div>
          <label>
            Username
            <input type="text" name="user" placeholder="your-username">
          </label>
          <label>
            Password
            <input type="password" name="pass" placeholder="your-password">
          </label>
        </div>
        
        <div id="appSesFields" style="display: none;">
          <label>
            AWS Access Key
            <input type="text" name="awsAccessKey" placeholder="AKIA...">
          </label>
          <label>
            AWS Secret Key
            <input type="password" name="awsSecretKey" placeholder="secret-key">
          </label>
          <label>
            AWS Region
            <input type="text" name="awsRegion" placeholder="us-east-1" value="us-east-1">
          </label>
        </div>
        
        <label>
          From Address
          <input type="email" name="fromAddress" placeholder="noreply@example.com" required>
        </label>
        <label>
          From Name
          <input type="text" name="fromName" placeholder="My Application">
        </label>
        
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="submit" id="saveAppConfigBtn">Save Configuration</button>
          <button type="button" id="testAppConfigBtn" class="smallBtn">Test Configuration</button>
          <button type="button" id="deleteAppConfigBtn" class="smallBtn" style="background: #dc3545; border-color: #dc3545; display: none;">Delete Configuration</button>
          <button type="button" id="cancelAppConfigBtn" class="smallBtn">Cancel</button>
        </div>
        
        <div id="appConfigStatus" class="status"></div>
      </form>
    </div>
  </div>
  
  <!-- SMS Configuration Modal -->
  <div id="smsConfigModal" style="position: fixed; inset: 0; background: rgba(0,0,0,.85); display: none; align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: #1e1e1e; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid #444; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,.5);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 id="smsModalTitle" style="margin: 0; color: #4fc3f7;">SMS Configuration</h2>
        <button id="closeSmsModalBtn" style="background: none; border: none; color: #999; font-size: 24px; cursor: pointer; padding: 4px;">&times;</button>
      </div>
      
      <form id="smsGlobalConfigForm" style="display: flex; flex-direction: column; gap: 16px;">
        <input type="hidden" id="smsEditConfigId" />
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label for="modalSmsSid">Twilio Account SID *</label>
            <input type="text" id="modalSmsSid" class="form-control" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
          </div>
          
          <div class="form-group">
            <label for="modalSmsToken">Twilio Auth Token *</label>
            <input type="password" id="modalSmsToken" class="form-control" placeholder="Your auth token" required>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label for="modalSmsFromNumber">From Phone Number *</label>
            <input type="tel" id="modalSmsFromNumber" class="form-control" placeholder="+1234567890" required>
          </div>
          
          <div class="form-group">
            <label for="modalSmsFallbackTo">Fallback Phone Number</label>
            <input type="tel" id="modalSmsFallbackTo" class="form-control" placeholder="+1234567890">
          </div>
        </div>
        
        <div class="form-group">
          <label for="modalSmsServiceSid">Messaging Service SID (Optional)</label>
          <input type="text" id="modalSmsServiceSid" class="form-control" placeholder="MGxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
          <small style="color: #888; font-size: 0.85rem; margin-top: 4px;">If provided, messages will use the messaging service instead of the from number</small>
        </div>
        
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="modalSmsIsActive" checked>
            <span>Active Configuration</span>
          </label>
          <small style="color: #888; font-size: 0.85rem; margin-top: 4px;">Only one configuration can be active per scope level</small>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="submit" class="config-btn config-btn-primary">Save SMS Configuration</button>
          <button type="button" id="deleteSmsModalBtn" class="config-btn config-btn-danger" style="display: none;">Delete</button>
          <button type="button" id="cancelSmsModalBtn" class="config-btn config-btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- App SMS Configuration Modal -->
  <div id="appSmsConfigModal" style="position: fixed; inset: 0; background: rgba(0,0,0,.85); display: none; align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: #1e1e1e; padding: 24px; max-width: 600px; width: 100%; border: 1px solid #444; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,.5); max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 id="appSmsModalTitle" style="margin: 0; color: #4fc3f7;">App SMS Configuration</h2>
        <button id="closeAppSmsModalBtn" style="background: none; border: none; color: #999; font-size: 24px; cursor: pointer; padding: 4px;">&times;</button>
      </div>
      
      <form id="appSmsConfigForm" style="display: flex; flex-direction: column; gap: 16px;">
        <input type="hidden" id="appSmsEditConfigId" />
        <input type="hidden" id="appSmsConfigAppId" />
        <input type="hidden" id="appSmsConfigTenantId" />
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label for="appModalSmsSid">Twilio Account SID *</label>
            <input type="text" id="appModalSmsSid" class="form-control" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
          </div>
          
          <div class="form-group">
            <label for="appModalSmsToken">Twilio Auth Token *</label>
            <input type="password" id="appModalSmsToken" class="form-control" placeholder="Your auth token" required>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label for="appModalSmsFromNumber">From Phone Number *</label>
            <input type="tel" id="appModalSmsFromNumber" class="form-control" placeholder="+1234567890" required>
          </div>
          
          <div class="form-group">
            <label for="appModalSmsFallbackTo">Fallback Phone Number</label>
            <input type="tel" id="appModalSmsFallbackTo" class="form-control" placeholder="+1234567890">
          </div>
        </div>
        
        <div class="form-group">
          <label for="appModalSmsServiceSid">Messaging Service SID (Optional)</label>
          <input type="text" id="appModalSmsServiceSid" class="form-control" placeholder="MGxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
          <small style="color: #888; font-size: 0.85rem; margin-top: 4px;">If provided, messages will use the messaging service instead of the from number</small>
        </div>
        
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="appModalSmsIsActive" checked>
            <span>Active Configuration</span>
          </label>
          <small style="color: #888; font-size: 0.85rem; margin-top: 4px;">Only one configuration can be active per app</small>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="submit" class="config-btn config-btn-primary">Save SMS Configuration</button>
          <button type="button" id="deleteAppSmsModalBtn" class="config-btn config-btn-danger" style="display: none;">Delete</button>
          <button type="button" id="cancelAppSmsModalBtn" class="config-btn config-btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  
  <div id="loginOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:1000">
    <div style="background:#1e1e1e;padding:24px;max-width:480px;width:100%;border:1px solid #444;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.5);">
      <h2 style="margin-top:0">Authenticate</h2>
      <p style="font-size:.9rem;line-height:1.3">Paste a JWT (Bearer token). It must be signed by the configured issuer and include roles claim. Stored only in localStorage.</p>
      <form id="loginForm">
        <label style="display:block;margin-bottom:8px">Token
          <textarea name="token" rows="5" style="width:100%;font-family:monospace" placeholder="eyJhbGciOiJSUzI1NiIs..." required></textarea>
        </label>
        <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
          <button type="submit">Use Token</button>
          <button type="button" id="loginCancelBtn" class="smallBtn" style="display:none">Cancel</button>
          <span id="loginStatus" class="status" style="flex:1;text-align:right"></span>
        </div>
      </form>
      <details style="margin-top:12px">
        <summary style="cursor:pointer">Dev Helper</summary>
        <p style="font-size:.8rem">If you generated a local key, mint a token in another terminal:<br/><code>npm run token -- --roles superadmin</code></p>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" id="loginAsSuperAdmin" class="smallBtn" style="background:#0d47a1; border:1px solid #1976d2;">Login as SuperAdmin</button>
          <button type="button" id="loginAsTenantAdmin" class="smallBtn" style="background:#1b5e20; border:1px solid #4caf50;">Login as Tenant Admin</button>
        </div>
      </details>
    </div>
  </div>
  <!-- Use compiled JS under /ui/ (dist build places main.js there). -->
  <script type="module" src="/ui/main.js"></script>
</body>
</html>
