<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mail Service - Compose</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/ui/styles.css" />
</head>
<body>
  <div id="app">
    <header>
      <h1 id="viewTitle">Mail Service</h1>
      <nav class="topnav">
        <button data-view="tenants" class="navBtn">Tenants</button>
        <button data-view="compose" class="navBtn">Compose</button>
      </nav>
      <div class="env" id="envInfo"></div>
      <div class="userPane" id="userPane" style="display:none">
        <span id="userSummary"></span>
        <button id="logoutBtn" class="smallBtn" type="button">Logout</button>
      </div>
    </header>
    <main class="layout" id="view-tenants" style="display:none">
      <section class="panel fullwidth">
        <h2>Tenants</h2>
        <form id="tenantForm">
          <label>New Tenant Name <input name="tenantName" placeholder="Tenant A" required /></label>
          <button type="submit">Create Tenant</button>
          <div class="status" id="tenantStatus"></div>
        </form>
        <div id="tenantList"></div>
      </section>
    </main>
    <main class="layout" id="view-compose">
      <section class="panel" id="tenantAppPanel">
        <h2>Context</h2>
        <div class="sub">
          <label>Tenant <select id="tenantSelect"></select></label>
        </div>
        <div class="sub">
          <label>App <select id="appSelect"></select></label>
        </div>
        <div style="margin-top:8px">
          <button type="button" id="goToTenantsBtn" class="smallBtn">Manage Tenants & Apps</button>
        </div>
        <div class="status" id="appStatus"></div>
      </section>
      <section class="panel">
        <h2>Template</h2>
        <form id="templateForm">
          <label>Name <input name="name" required placeholder="welcome" /></label>
          <label>Version <input name="version" type="number" value="1" min="1" required /></label>
          <label>Subject <input name="subject" required placeholder="Hello {{name}}" /></label>
          <label>Body (HTML)
            <textarea name="bodyHtml" rows="6" placeholder="<p>Hi {{name}}</p>"></textarea>
          </label>
          <label>Body (Text)
            <textarea name="bodyText" rows="4" placeholder="Hi {{name}}"></textarea>
          </label>
          <label>Variables (JSON)
            <textarea name="variables" rows="3" placeholder="{ }"></textarea>
          </label>
          <button type="submit">Save Template</button>
          <div class="status" id="templateStatus"></div>
        </form>
        <div id="templateList"></div>
        <div style="margin-top:8px">
          <button id="deactivateTemplateBtn" type="button" disabled>Deactivate Template</button>
        </div>
      </section>
      <section class="panel">
        <h2>Render Preview</h2>
        <form id="renderForm">
          <label>Context (JSON)
            <textarea name="context" rows="6" placeholder='{"name":"Alice"}'></textarea>
          </label>
          <button type="submit">Render</button>
          <div class="status" id="renderStatus"></div>
        </form>
        <div class="preview">
          <h3>Subject</h3>
          <div id="previewSubject" class="code"></div>
          <h3>HTML</h3>
            <iframe id="previewHtml"></iframe>
          <h3>Text</h3>
          <pre id="previewText" class="code"></pre>
        </div>
      </section>
      <section class="panel">
  <h2>Send Group</h2>
        <form id="groupForm">
          <label>Group Subject <input name="groupSubject" placeholder="Announcement" required /></label>
          <label>Recipients (CSV emails, one per line)
            <textarea name="recipients" rows="6" placeholder="user1@example.com\nuser2@example.com"></textarea>
          </label>
          <button type="submit">Create + Send (Dry Run)</button>
          <div class="status" id="groupStatus"></div>
        </form>
        <div id="groupEvents"></div>
          <div style="margin-top:8px">
            <button id="cancelGroupBtn" type="button" disabled>Cancel Group</button>
          </div>
      </section>
      <section class="panel" id="activityPanel">
        <h2>Recent Groups</h2>
        <div id="groupsList" class="code" style="max-height:180px;overflow:auto"></div>
        <h3 style="margin-top:12px">Group Events</h3>
        <div id="eventsList" class="code" style="max-height:200px;overflow:auto"></div>
      </section>
      <section class="panel">
        <h2>Quick Send (No Template)</h2>
        <form id="quickSendForm">
          <label>Subject <input name="qsSubject" placeholder="Hello" required /></label>
          <label>HTML Body
            <textarea name="qsHtml" rows="6" placeholder="<p>Hello world</p>"></textarea>
          </label>
          <label>Text Body
            <textarea name="qsText" rows="4" placeholder="Hello world"></textarea>
          </label>
          <label>Recipients (emails, one per line)
            <textarea name="qsRecipients" rows="5" placeholder="user@example.com"></textarea>
          </label>
          <button type="submit">Send Now</button>
          <div class="status" id="quickSendStatus"></div>
        </form>
      </section>
    </main>
  </div>
  <div id="loginOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:1000">
    <div style="background:#1e1e1e;padding:24px;max-width:480px;width:100%;border:1px solid #444;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.5);">
      <h2 style="margin-top:0">Authenticate</h2>
      <p style="font-size:.9rem;line-height:1.3">Paste a JWT (Bearer token). It must be signed by the configured issuer and include roles claim. Stored only in localStorage.</p>
      <form id="loginForm">
        <label style="display:block;margin-bottom:8px">Token
          <textarea name="token" rows="5" style="width:100%;font-family:monospace" placeholder="eyJhbGciOiJSUzI1NiIs..." required></textarea>
        </label>
        <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
          <button type="submit">Use Token</button>
          <button type="button" id="loginCancelBtn" class="smallBtn" style="display:none">Cancel</button>
          <span id="loginStatus" class="status" style="flex:1;text-align:right"></span>
        </div>
      </form>
      <details style="margin-top:12px">
        <summary style="cursor:pointer">Dev Helper</summary>
        <p style="font-size:.8rem">If you generated a local key, mint a token in another terminal:<br/><code>npm run token -- --roles superadmin</code></p>
      </details>
    </div>
  </div>
  <!-- Use compiled JS under /ui/ (dist build places main.js there). -->
  <script src="/ui/config.js"></script>
  <script type="module" src="/ui/main.js"></script>
</body>
</html>
